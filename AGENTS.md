# Repository Guidelines

## Project Structure & Module Organization
Core simulation code is under `src/pysm3`, split into submodules for sky models, utilities, and version metadata (`_version.py` is generated by Hatch). Unit and regression tests live in `tests`, mirroring the source layout with `test_*` modules plus helpers for synthetic skies. Documentation is authored in `docs`, a Sphinx project that also hosts example notebooks executed during CI. Supporting assets include `ci/` for workflow scripts, `mpi_examples/` with minimal MPI drivers, and `run_mpi_tests.sh` for exercising distributed builds.

## Build, Test, and Development Commands
Always create local environments with `uv venv .venv && source .venv/bin/activate`, then install extras via `uv pip install -e .[test]`. Local test runs should use `uv run pytest -v` so the same interpreter executes the suite (nbval notebooks included). For coverage artifacts run `uv run pytest --cov pysm3 --cov-report=xml`; the XML ends up in `coverage.xml`. Enforce formatting via `uv run flake8 src/pysm3 --count --max-line-length=100`. Build documentation with `uv run sphinx-build -W -b html docs docs/_build/html`, and check external links via `uv run sphinx-build -W -b linkcheck docs docs/_build/linkcheck`. For MPI smoke tests, install the `mpi` extra and execute `./run_mpi_tests.sh`.

## Coding Style & Naming Conventions
Follow standard 4-space indentation, PEP 8 imports, and explicit type hints in new public APIs. Modules and packages are lowercase with underscores; classes use CapWords; functions, variables, and fixtures use snake_case. Keep public docstrings short but explicit about units. `flake8` (and Ruff’s lint profile defined in `pyproject.toml`) rejects long lines over 100 chars, unused imports, and logging/pytest antipatterns—run linters before opening a PR.

## Testing Guidelines
Prefer focused `test_<unit>.py` modules colocated with peers in `tests/`, and mark longer integrations with `@pytest.mark.slow`. Notebook-based acceptance tests live in `docs/*.ipynb`; touch them only when narratives change and re-run `pytest --nbval`. Aim to keep coverage steady; if adding broad features, run `uv run pytest --cov pysm3 --cov-report=xml` and inspect `coverage.xml`. When modifying MPI paths, use `mpirun -n 4 pytest tests/mpi` (after installing `mpi4py`) to catch race conditions early.

## Commit & Pull Request Guidelines
Commits are short, imperative sentences (e.g., “Refine dust polarization prior”) and should bundle related code, tests, and docs. Reference GitHub issues in the body when closing or relating work (`Fixes #123`). Before pushing, ensure `uv run pytest -v`, `uv run flake8 src/pysm3 --count --max-line-length=100`, and `uv run sphinx-build -W -b html docs docs/_build/html` all succeed locally. Pull requests need a concise summary, a checklist of test results, and—when applicable—links to rendered docs or plots so reviewers can reproduce outputs quickly.
