# Repository Guidelines

## Project Overview
PySM (Python Sky Model) generates full-sky simulations of Galactic foreground emissions in intensity and polarization for Cosmic Microwave Background (CMB) experiments. It uses HEALPix pixelization via `healpy` and supports MPI parallelization.

## Project Structure & Key Files

```
src/pysm3/
├── __init__.py          # Public API exports
├── sky.py               # Main Sky class for combining components
├── models/              # Sky model implementations (dust, synchrotron, CMB, etc.)
├── utils/               # Helper functions for map I/O, smoothing
├── units.py             # Unit conversion utilities (uses astropy.units)
├── mpi.py               # MPI distribution helpers
└── data/                # Model configuration files (TOML)

tests/
├── test_dust.py         # Dust model tests
├── test_synchrotron.py  # Synchrotron model tests
├── test_cmb.py          # CMB model tests
└── test_*.py            # Other component tests

docs/
├── *.ipynb              # Jupyter notebooks (executed during CI via nbval)
├── conf.py              # Sphinx configuration
└── *.rst                # RST documentation files
```

## Quick Start Commands

```bash
# Setup environment
uv venv .venv && source .venv/bin/activate
uv pip install -e .[test]

# Run tests (includes notebook validation)
uv run pytest -v

# Run specific test file
uv run pytest tests/test_dust.py -v

# Lint code
uv run flake8 src/pysm3 --count --max-line-length=100

# Build documentation
uv run sphinx-build -W -b html docs docs/_build/html

# Coverage report
uv run pytest --cov pysm3 --cov-report=xml
```

## Key Dependencies
- `healpy`: HEALPix sphere pixelization and spherical harmonics
- `astropy`: Physical units and FITS file handling
- `numba`: JIT compilation for performance-critical code
- `numpy`, `scipy`: Numerical operations
- `h5py`: HDF5 file format support
- `mpi4py` (optional): MPI parallelization

## Coding Style & Naming Conventions
- 4-space indentation, PEP 8 imports
- Type hints in new public APIs
- Modules/packages: lowercase with underscores (e.g., `dust_model`)
- Classes: CapWords (e.g., `ModifiedBlackBody`)
- Functions/variables: snake_case (e.g., `get_emission`)
- Max line length: 100 characters
- Docstrings: explicit about physical units (e.g., "Returns intensity in uK_RJ")

## Testing Guidelines
- Test files: `tests/test_<component>.py`
- Mark slow tests with `@pytest.mark.slow`
- Notebooks in `docs/` are validated via `--nbval`
- MPI tests: `./run_mpi_tests.sh` (requires `mpi4py`)

## Common Model Tags
When working with sky models, these tags are commonly used:
- Dust: `d0`-`d12` (modified blackbody variants)
- Synchrotron: `s0`-`s7` (power-law variants)
- CMB: `c1`-`c4`
- AME: `a1`, `a2` (anomalous microwave emission)
- Free-free: `f1`

## Important Notes for Contributors
1. The `_version.py` file is auto-generated by Hatch - do not edit manually
2. Model data files are downloaded from remote servers; tests may require network access
3. HEALPix maps use RING ordering by default
4. Frequency units are typically GHz; intensity units are typically uK_RJ or uK_CMB
5. Run both linter and tests before submitting PRs:
   ```bash
   uv run flake8 src/pysm3 --count --max-line-length=100 && uv run pytest -v
   ```

## Commit & Pull Request Guidelines
- Commits: short imperative sentences (e.g., "Add dust layer interpolation")
- Reference issues in commit body: `Fixes #123`
- PRs need: concise summary, test results checklist, links to rendered docs if applicable
- Always use the GitHub CLI `gh` when interacting with GitHub (PRs, issues, checks, comments)
